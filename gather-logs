#!/bin/bash

set -o nounset

readonly ExecAbsPath=$(readlink --canonicalize "$0")
readonly ExecDir=$(dirname "$ExecAbsPath")
readonly LogBase=rodsLog


main()
{
  local host="$1"
  local logExtPat="$2"

  local password=
  if [ "$#" -ge 3 ]
  then
    password="$3"
  fi

  local namePat="$LogBase"."$logExtPat"

  local log
  for log in $("$ExecDir"/list-rods-logs --name-pattern "$namePat" --password "$password" "$host")
  do
    local logName
    logName=$(basename "$log")

    rcat_log "$host" "$password" "$log" \
      | "$ExecDir"/format-log-entries --assign YEAR="${logName:8:4}"

    printf 'gather_logs:  finished processing %s\n' "$logName" >&2
  done
}


rcat_log()
{
  local host="$1"
  local password="$2"
  local log="$3"

  #shellcheck disable=SC2087
  ssh -q -t "$host" \
<<EOF 2> /dev/null
  printf '%s\n' "$password" | sudo -S cat "$log"
EOF
}


main "$@"
